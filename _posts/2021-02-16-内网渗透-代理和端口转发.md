---
title: 内网渗透-代理和端口转发
published: true
--- 
&nbsp;

## 0x00 前言
----
常处在企业内网，深知内网安全的重要性。今天就来整理一下内网渗透中经常会用到的代理和端口转发。  

在复杂的网络结构中，经常在渗透过程中会根据实际场景去布置代理和端口转发。  

![NO.1](https://cer1vk.github.io/image/2021-2/2021-2-16/proxyandforwardport.png) 

我认为主要的原因可以归纳为以下几点：  

1. 两者的应用场景不同。例如，仅仅为了隐蔽，那么通过跳板机实现端口流量转发就已经达到目的，但是有时候需要面对跳板机的一侧有多台server，这种情况下肯定是通过将跳板机布置成代理server会更加合适。  

2. 中间有防火墙和安全阻断机制。这个时候利用目标环境自带的工具可以灵活的去应用，那么端口转发能达到此般目的的就无需上传代理工具。  

3. 混淆防御者。一般防御者在面对突发应急情况下，如果发现一处威胁，可能就会放弃深入探索。这时候两种方案同行，就可以给入侵制造更好的机会。  

4. 如果探测的网络环节需要经过多级联操作，那么就很有必要将端口转发和代理组合应用，针对网络的不同节点去精心布置，这也是两者贴合的使用的情况之一。  

那么下面我们将进入本次实验主题。  

## 0x01 实验环境
----
此类工具较多，但本文主要研究的范围如下：  

* A/B网，模拟正向和反向连接场景  

*  攻击机/受害者(win && linux)  

* netsh(window)  

* ssh(win && linux)  

* lcx(window)/portmap(linux)  

* nc(win && linux)  

* chisel(win && linux)  

* ew(win && linux)  

* proxifier(windows)  

* proxychains(linux)  


**注意：建议到官方网站下载工具，避免后门远控**  

## 0x02 简介
----
本文将按照以下几块内容说明：    

```js
* 端口转发-正向连接  

* 端口转发-反向连接 

* 应用场景

* 代理 

* 反向代理应用场景  
```


## 0x03 端口转发-正向连接
----
目标位于内网，不能直接访问的，需要依靠中间机子负责转送流量，然后两者建立通信。  
如，下图场景示例：  

![active](https://cer1vk.github.io/image/2021-2/2021-2-16/正向连接端口转发.png)   

#### 注：  
vps作为中间纽带，通过接收外部**（入站并没有限制）**流量将它转到内网。  

### window netsh的使用规则  
1） *netsh interface portproxy add v4tov4 listenaddress=192.168.43.162 listenport=9999 connectaddress=53.24.11.2  connectport=3389*  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/netsh01.png)   

需要管理员权限运行cmd  

2） 执行后，查看端口信息，*netsh interface portproxy show all*  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/netsh02.png)   

3） 在client端（cmd-->mstsc）去访问192.168.43.162:9999将跳转到53.24.11.2:3389  

4） 通过清理和重置取消规则,*netsh interface portproxy reset*  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/netsh03.png)   


### linux ssh的正向连接规则  


## 0x04 端口转发-反向连接
----


## 0x05 应用场景
----



## 0x06 代理
----

 

## 0x07 反向代理应用场景
----


## 0x08 小结
----


----
### [Reference]
* [1] https://  
* [2] https://  
* [3] https://  
