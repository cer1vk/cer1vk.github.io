---
title: 内网渗透-代理和端口转发
published: true
--- 
&nbsp;

## 0x00 前言
----
常处在企业内网，深知内网安全的重要性。今天就来整理一下内网渗透中经常会用到的代理和端口转发。  

在复杂的网络结构中，经常在渗透过程中会根据实际场景去布置代理和端口转发。  

![NO.1](https://cer1vk.github.io/image/2021-2/2021-2-16/proxyandforwardport.png) 

我认为主要的原因可以归纳为以下几点：  

1. 两者的应用场景不同。例如，仅仅为了隐蔽，那么通过跳板机实现端口流量转发就已经达到目的，但是有时候需要面对跳板机的一侧有多台server，这种情况下肯定是通过将跳板机布置成代理server会更加合适。  

2. 中间有防火墙和安全阻断机制。这个时候利用目标环境自带的工具可以灵活的去应用，那么端口转发能达到此般目的的就无需上传代理工具。  

3. 混淆防御者。一般防御者在面对突发应急情况下，如果发现一处威胁，可能就会放弃深入探索。这时候两种方案同行，就可以给入侵制造更好的机会。  

4. 如果探测的网络环节需要经过多级联操作，那么就很有必要将端口转发和代理组合应用，针对网络的不同节点去精心布置，这也是两者贴合的使用的情况之一。  

那么下面我们将进入本次实验主题。  

## 0x01 实验环境
----
此类工具较多，但本文主要研究的范围如下：  

* A/B网，模拟正向和反向连接场景  

*  攻击机/受害者(win && linux)  

* netsh(window)  

* ssh(win && linux)  

* lcx(window)/portmap(linux)  

* nc(win && linux)  

* chisel(win && linux)  

* ew(win && linux)  

* proxifier(windows)  

* proxychains(linux)  


**注意：建议到官方网站下载工具，避免后门远控**  

## 0x02 简介
----
本文将按照以下几块内容说明：    

```js
* 端口转发-正向连接  

* 端口转发-反向连接 

* 应用场景

* 代理 

* 反向代理应用场景  
```


## 0x03 端口转发-正向连接
----
目标位于内网，不能直接访问的，需要依靠中间机子负责转送流量，然后两者建立通信。  
如，下图场景示例：  

![active](https://cer1vk.github.io/image/2021-2/2021-2-16/正向连接端口转发.png)   

#### 注：  
vps作为中间纽带，通过接收外部**（入站并没有限制）**流量将它转到内网。  

### window netsh的使用规则  
1） *netsh interface portproxy add v4tov4 listenaddress=192.168.43.162 listenport=9999 connectaddress=53.24.11.2  connectport=3389*  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/netsh01.png)   

需要管理员权限运行cmd  

2） 执行后，查看端口信息，*netsh interface portproxy show all*  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/netsh02.png)   

3） 在client端（cmd-->mstsc）去访问192.168.43.162:9999将跳转到53.24.11.2:3389  

4） 通过清理和重置取消规则,*netsh interface portproxy reset*  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/netsh03.png)   


### linux ssh的正向连接规则  
经过ssh之间的网络数据都是加密处理的。所以，如果通过ssh建立的隧道安全且隐蔽。  

这里假设，三台主机，host1、host2、host3之间关系是，host1和host2不能直接通信，但是host3能够和两者相通，且host3对入口没有任何限制。  
因此，可以通过host3进行端口转发实现host1访问host2。  

> host1-->host3-->host2  

1) 应用ssh的本地端口转发功能，即在host1上执行*ssh -CNfL localport：host3address：host3port host2address*  
```js
测试地址:
host1:10.0.2.15
host2:192.168.1.158
host3:192.168.1.249
```
2) 在host1上执行ssh -CNfL 2222:192.168.1.249:23 192.168.1.158  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/ssh01.png)   

3) 在host1上执行telnet连接本地2222端口，成功后便可以访问host3  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/ssh02.png)   

#### 注：
host2作为中转机子，需要把转发的功能激活，如果监听的地址是127.0.0.1:2222则无法实现转发，正确的监听地址应该是0.0.0.0:2222。  

遇到以上情况，按一下进行配置即可：  

```js
1. 在host2的/etc/ssh/sshd_config上添加或设置如下:

AllowTcpForwarding yes
GatewayPorts yes
TCPKeepAlive yes  
PasswordAuthentication yes

2. 在文件末添加以下一行(如已有则不必添加,直接将注释解除即可)
vi /etc/sysctl.conf
net.ipv4.ip_forward=1
```

### windows lcx正向连接配置规则
lcx有windows版本和linux版本，本文就说一说windows版下的场景及使用。  

***lcx的使用方法:***  
```js
使用端口映射(tran)功能:

lcx -tran 本端端口 目标地址 目标端口  

测试地址:
host1:192.168.1.163
host2:192.168.1.10
host3:192.168.1.158
```
1) 在host1上执行*lcx -tran 9999 192.168.1.10 3389*  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/lcx01.png)   

2）连接host1的端口9999，将传送到host2的3389远程访问  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/lcx02.png)   
打开连接后，可以看到已经在运作。  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/lcx03.png)   

3）此时host2如果作为vps，host1和host3均为内网主机，受网络限制只允许host1出网访问，则该方法在这种场景下可以应用。  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/lcx04.png)   

### windows nc正向连接配置规则
使用nc的优点是，许多linux的发行版都自带，作为这样的合规软件，一般只有windows下才受AC制约，本文来演示一下win server下nc的正向连接使用。  

***应用场景如下***  

- 假设host1能访问host2,单host2不能访问host1  
- host2获取host1弹过去的shell  
```js
测试地址:
host1:192.168.1.171
host2:10.0.2.15
```

1）在host1上开启端口*nc -lp 9999 -e cmd.exe*，同时在host2上执行*nc -nvv 192.168.1.171*  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/nc01.png)   
host2上已经成功连接到host1的shell  
![active](https://cer1vk.github.io/image/2021-2/2021-2-16/nc02.png)   

#### 注：
除了以上几种方案，linux的自带的防火墙工具实现的端口转发和映射效果也很好，可以参考:  
https://juejin.cn/post/6857761379600826376。  

## 0x04 端口转发-反向连接
----


## 0x05 应用场景
----



## 0x06 代理
----

 

## 0x07 反向代理应用场景
----


## 0x08 小结
----


----
### [Reference]
* [1] https://  
* [2] https://  
* [3] https://  
